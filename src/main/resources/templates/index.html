<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.css" rel="stylesheet">
    <style>
        .upload-container {
            max-width: 600px;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .results-container {
            display: none;
            margin-top: 2rem;
        }
        .analysis-container {
            height: 70vh;
            overflow-y: auto;
            padding-right: 1rem;
        }
        .analysis-container::-webkit-scrollbar {
            width: 8px;
        }
        .analysis-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .analysis-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .analysis-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #dee2e6;
        }
        .stat-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stat-card.expanded {
            background: white;
        }
        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .stat-card-header h4 {
            margin: 0;
        }
        .stat-card-content {
            display: none;
            margin-top: 1rem;
        }
        .stat-card.expanded .stat-card-content {
            display: block;
        }
        .data-type-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }
        .numeric-badge {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .text-badge {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        .chart-container {
            margin: 2rem 0;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        .card {
            height: auto;
        }
        .card-body {
            display: flex;
            flex-direction: column;
        }
        canvas {
            min-height: 300px;
        }
        .chart-controls {
            display: flex;
            gap: 2rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .chart-control-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .chart-control-group h4 {
            margin: 0;
            font-size: 1rem;
        }
        .chart-control-options {
            display: flex;
            gap: 1rem;
        }
        .chart-control-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .legend-item:hover {
            background-color: #e9ecef;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }
        .legend-item.hidden {
            opacity: 0.5;
        }
        .top-values {
            margin-top: 1rem;
        }
        .top-value-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        .sort-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .sort-select {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            border: 1px solid #dee2e6;
            background-color: white;
            cursor: pointer;
        }
        .chart-settings {
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="upload-container">
            <h1 class="text-center mb-4">CSV Analyzer</h1>
            <div class="card">
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="file" class="form-label">Choose a CSV file</label>
                            <input type="file" class="form-control" id="file" name="file" accept=".csv" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Analyze</button>
                    </form>
                </div>
            </div>
        </div>

        <div id="results" class="results-container">
            <div class="row">
                <div class="col-md-6">
                    <div class="d-flex justify-content-between align-items-center">
                        <h3>Analysis Results</h3>
                        <div class="sort-controls">
                            <span>Order by:</span>
                            <select class="sort-select" id="sortSelect">
                                <option value="default">Default (CSV Order)</option>
                                <option value="type">Data Type</option>
                            </select>
                        </div>
                    </div>
                    <div class="analysis-container" id="analysis"></div>
                </div>
                <div class="col-md-6">
                    <h3>Data Preview</h3>
                    <div class="table-responsive">
                        <table class="table table-striped" id="dataPreview">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <h3>Data Visualization</h3>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h4>Histogram</h4>
                                <canvas id="histogramChart"></canvas>
                                <div class="mt-3">
                                    <div class="mb-3">
                                        <label for="histogramColumn" class="form-label">Select Column:</label>
                                        <select class="form-select" id="histogramColumn">
                                            <option value="">Select a column</option>
                                        </select>
                                    </div>
                                    <div class="chart-settings">
                                        <h5>Statistics</h5>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="histogramMean">
                                            <label class="form-check-label" for="histogramMean">Show Mean</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="histogramMedian">
                                            <label class="form-check-label" for="histogramMedian">Show Median</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="histogramStd">
                                            <label class="form-check-label" for="histogramStd">Show Standard Deviation</label>
                                        </div>
                                        <h5 class="mt-3">Display Settings</h5>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="histogramGrid">
                                            <label class="form-check-label" for="histogramGrid">Show Grid</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="histogramLogX">
                                            <label class="form-check-label" for="histogramLogX">Logarithmic X Scale</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="histogramLogY">
                                            <label class="form-check-label" for="histogramLogY">Logarithmic Y Scale</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h4>Scatter Plot</h4>
                                <canvas id="scatterChart"></canvas>
                                <div class="mt-3">
                                    <div class="row mb-3">
                                        <div class="col">
                                            <label for="scatterX" class="form-label">X Axis:</label>
                                            <select class="form-select" id="scatterX">
                                                <option value="">Select X column</option>
                                            </select>
                                        </div>
                                        <div class="col">
                                            <label for="scatterY" class="form-label">Y Axis:</label>
                                            <select class="form-select" id="scatterY">
                                                <option value="">Select Y column</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="chart-settings">
                                        <h5>Statistics</h5>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="scatterMean">
                                            <label class="form-check-label" for="scatterMean">Show Mean</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="scatterMedian">
                                            <label class="form-check-label" for="scatterMedian">Show Median</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="scatterStd">
                                            <label class="form-check-label" for="scatterStd">Show Standard Deviation</label>
                                        </div>
                                        <h5 class="mt-3">Display Settings</h5>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="scatterGrid">
                                            <label class="form-check-label" for="scatterGrid">Show Grid</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="scatterLogX">
                                            <label class="form-check-label" for="scatterLogX">Logarithmic X Scale</label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="scatterLogY">
                                            <label class="form-check-label" for="scatterLogY">Logarithmic Y Scale</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script>
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('file', document.getElementById('file').files[0]);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                displayResults(data);
            } catch (error) {
                console.error('Error:', error);
                alert('Error processing file. Please try again.');
            }
        });

        function displayResults(data) {
            document.getElementById('results').style.display = 'block';
            displayAnalysis(data.analysis, data.headers);
            displayDataPreview(data.data, data.headers);
            initializeCharts(data.data, data.headers);
        }

        function displayAnalysis(analysis, headers) {
            const analysisContainer = document.getElementById('analysis');
            analysisContainer.innerHTML = '';

            // Store the original order of columns (matching the CSV headers)
            const originalOrder = headers;

            // Create sort select event listener
            const sortSelect = document.getElementById('sortSelect');
            sortSelect.addEventListener('change', () => {
                const sortType = sortSelect.value;
                renderAnalysis(analysis, sortType, originalOrder);
            });

            // Initial render with default sort
            renderAnalysis(analysis, 'default', originalOrder);
        }

        function renderAnalysis(analysis, sortType, originalOrder) {
            const analysisContainer = document.getElementById('analysis');
            analysisContainer.innerHTML = '';

            // Get sorted columns based on sort type
            let columns;
            if (sortType === 'type') {
                // Create arrays for each data type
                const numericColumns = [];
                const textColumns = [];

                // Sort columns into their respective type arrays while maintaining original order
                originalOrder.forEach(column => {
                    if (analysis[column].mean !== undefined) {
                        numericColumns.push(column);
                    } else {
                        textColumns.push(column);
                    }
                });

                // Combine arrays with numeric columns first
                columns = [...numericColumns, ...textColumns];
            } else {
                columns = originalOrder;
            }

            // Create cards for each column
            columns.forEach(column => {
                const stats = analysis[column];
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                
                // Determine data type
                const isNumeric = stats.mean !== undefined;
                const dataType = isNumeric ? 'Numeric' : 'Text';
                const dataTypeClass = isNumeric ? 'numeric-badge' : 'text-badge';
                
                statCard.innerHTML = `
                    <div class="stat-card-header">
                        <h4>${column}</h4>
                        <span class="data-type-badge ${dataTypeClass}">${dataType}</span>
                    </div>
                    <div class="stat-card-content">
                        <ul class="list-unstyled">
                            <li>Total Count: ${stats.count}</li>
                            <li>Null Values: ${stats.nullCount}</li>
                            ${isNumeric ? `
                                <li>Mean: ${stats.mean.toFixed(2)}</li>
                                <li>Median: ${stats.median.toFixed(2)}</li>
                                <li>Standard Deviation: ${stats.stdDev.toFixed(2)}</li>
                                <li>Min: ${stats.min.toFixed(2)}</li>
                                <li>Max: ${stats.max.toFixed(2)}</li>
                            ` : `
                                <li>Unique Values: ${stats.uniqueCount}</li>
                                ${stats.topValues && stats.topValues.length > 0 ? `
                                    <li class="top-values">Top Values:
                                        <div class="top-values-list">
                                            ${stats.topValues.map(item => `
                                                <div class="top-value-item">
                                                    <span>${item.value}</span>
                                                    <span>${item.count} times</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </li>
                                ` : ''}
                            `}
                        </ul>
                    </div>
                `;

                // Add click event to toggle expansion
                statCard.addEventListener('click', () => {
                    statCard.classList.toggle('expanded');
                });

                analysisContainer.appendChild(statCard);
            });
        }

        function displayDataPreview(data, headers) {
            const table = document.getElementById('dataPreview');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');

            // Clear existing content
            thead.innerHTML = '';
            tbody.innerHTML = '';

            // Create header row
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            // Create data rows (limit to 10 rows for preview)
            data.slice(0, 10).forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header] || '';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function initializeCharts(data, headers) {
            // Find numeric columns
            const numericColumns = headers.filter(header => {
                const value = data[0][header];
                return value && !isNaN(parseFloat(value)) && isFinite(value);
            });

            if (numericColumns.length === 0) return;

            // Populate dropdowns
            const histogramSelect = document.getElementById('histogramColumn');
            const scatterXSelect = document.getElementById('scatterX');
            const scatterYSelect = document.getElementById('scatterY');

            numericColumns.forEach(column => {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                histogramSelect.appendChild(option.cloneNode(true));
                scatterXSelect.appendChild(option.cloneNode(true));
                scatterYSelect.appendChild(option.cloneNode(true));
            });

            // Initialize charts
            let histogramChart = null;
            let scatterChart = null;

            // Histogram chart
            function updateHistogram() {
                const selectedColumn = histogramSelect.value;
                if (!selectedColumn) return;

                const values = data.map(row => parseFloat(row[selectedColumn]) || 0);
                const min = Math.min(...values);
                const max = Math.max(...values);
                const range = max - min;
                
                // Calculate optimal number of bins (between 10 and 50)
                const binCount = Math.min(50, Math.max(10, Math.ceil(Math.sqrt(values.length))));
                const binSize = range / binCount;

                const bins = Array(binCount).fill(0);
                values.forEach(value => {
                    const binIndex = Math.min(Math.floor((value - min) / binSize), binCount - 1);
                    bins[binIndex]++;
                });

                const binLabels = Array.from({length: binCount}, (_, i) => {
                    const start = min + i * binSize;
                    const end = start + binSize;
                    return `${start.toFixed(2)} - ${end.toFixed(2)}`;
                });

                if (histogramChart) {
                    histogramChart.destroy();
                }

                const histogramCtx = document.getElementById('histogramChart').getContext('2d');
                const datasets = [{
                    label: `Distribution of ${selectedColumn}`,
                    data: bins,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }];

                histogramChart = new Chart(histogramCtx, {
                    type: 'bar',
                    data: {
                        labels: binLabels,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `Histogram of ${selectedColumn}`
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Frequency'
                                },
                                type: document.getElementById('histogramLogY').checked ? 'logarithmic' : 'linear',
                                grid: {
                                    display: document.getElementById('histogramGrid').checked
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Value Range'
                                },
                                type: document.getElementById('histogramLogX').checked ? 'logarithmic' : 'linear',
                                grid: {
                                    display: document.getElementById('histogramGrid').checked
                                }
                            }
                        }
                    }
                });
            }

            // Scatter plot
            function updateScatterPlot() {
                const xColumn = scatterXSelect.value;
                const yColumn = scatterYSelect.value;
                if (!xColumn || !yColumn) return;

                const xValues = data.map(row => parseFloat(row[xColumn]) || 0);
                const yValues = data.map(row => parseFloat(row[yColumn]) || 0);

                if (scatterChart) {
                    scatterChart.destroy();
                }

                const scatterCtx = document.getElementById('scatterChart').getContext('2d');
                const datasets = [{
                    label: `${yColumn} vs ${xColumn}`,
                    data: xValues.map((x, i) => ({x, y: yValues[i]})),
                    backgroundColor: 'rgba(255, 99, 132, 0.5)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }];

                // Add statistics if enabled
                const xMean = xValues.reduce((a, b) => a + b, 0) / xValues.length;
                const yMean = yValues.reduce((a, b) => a + b, 0) / yValues.length;
                const xSorted = [...xValues].sort((a, b) => a - b);
                const ySorted = [...yValues].sort((a, b) => a - b);
                const xMedian = xSorted[Math.floor(xSorted.length / 2)];
                const yMedian = ySorted[Math.floor(ySorted.length / 2)];
                const xStd = Math.sqrt(xValues.reduce((a, b) => a + Math.pow(b - xMean, 2), 0) / xValues.length);
                const yStd = Math.sqrt(yValues.reduce((a, b) => a + Math.pow(b - yMean, 2), 0) / yValues.length);

                if (document.getElementById('scatterMean').checked) {
                    datasets.push({
                        label: 'X Mean',
                        data: [{x: xMean, y: Math.min(...yValues)}, {x: xMean, y: Math.max(...yValues)}],
                        borderColor: 'rgba(255, 0, 0, 1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        type: 'line'
                    });
                    datasets.push({
                        label: 'Y Mean',
                        data: [{x: Math.min(...xValues), y: yMean}, {x: Math.max(...xValues), y: yMean}],
                        borderColor: 'rgba(255, 0, 0, 1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: false,
                        type: 'line'
                    });
                }

                if (document.getElementById('scatterMedian').checked) {
                    datasets.push({
                        label: 'X Median',
                        data: [{x: xMedian, y: Math.min(...yValues)}, {x: xMedian, y: Math.max(...yValues)}],
                        borderColor: 'rgba(0, 255, 0, 1)',
                        borderWidth: 2,
                        borderDash: [2, 2],
                        fill: false,
                        type: 'line'
                    });
                    datasets.push({
                        label: 'Y Median',
                        data: [{x: Math.min(...xValues), y: yMedian}, {x: Math.max(...xValues), y: yMedian}],
                        borderColor: 'rgba(0, 255, 0, 1)',
                        borderWidth: 2,
                        borderDash: [2, 2],
                        fill: false,
                        type: 'line'
                    });
                }

                if (document.getElementById('scatterStd').checked) {
                    datasets.push({
                        label: 'X Mean ± Std',
                        data: [
                            {x: xMean + xStd, y: Math.min(...yValues)},
                            {x: xMean + xStd, y: Math.max(...yValues)},
                            {x: xMean - xStd, y: Math.max(...yValues)},
                            {x: xMean - xStd, y: Math.min(...yValues)}
                        ],
                        borderColor: 'rgba(255, 165, 0, 1)',
                        borderWidth: 2,
                        borderDash: [1, 1],
                        fill: false,
                        type: 'line'
                    });
                    datasets.push({
                        label: 'Y Mean ± Std',
                        data: [
                            {x: Math.min(...xValues), y: yMean + yStd},
                            {x: Math.max(...xValues), y: yMean + yStd},
                            {x: Math.max(...xValues), y: yMean - yStd},
                            {x: Math.min(...xValues), y: yMean - yStd}
                        ],
                        borderColor: 'rgba(255, 165, 0, 1)',
                        borderWidth: 2,
                        borderDash: [1, 1],
                        fill: false,
                        type: 'line'
                    });
                }

                scatterChart = new Chart(scatterCtx, {
                    type: 'scatter',
                    data: {
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `${yColumn} vs ${xColumn}`
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: xColumn
                                },
                                type: document.getElementById('scatterLogX').checked ? 'logarithmic' : 'linear',
                                grid: {
                                    display: document.getElementById('scatterGrid').checked
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: yColumn
                                },
                                type: document.getElementById('scatterLogY').checked ? 'logarithmic' : 'linear',
                                grid: {
                                    display: document.getElementById('scatterGrid').checked
                                }
                            }
                        }
                    }
                });
            }

            // Add event listeners
            histogramSelect.addEventListener('change', updateHistogram);
            document.getElementById('histogramMean').addEventListener('change', updateHistogram);
            document.getElementById('histogramMedian').addEventListener('change', updateHistogram);
            document.getElementById('histogramStd').addEventListener('change', updateHistogram);
            document.getElementById('histogramGrid').addEventListener('change', updateHistogram);
            document.getElementById('histogramLogX').addEventListener('change', updateHistogram);
            document.getElementById('histogramLogY').addEventListener('change', updateHistogram);

            scatterXSelect.addEventListener('change', updateScatterPlot);
            scatterYSelect.addEventListener('change', updateScatterPlot);
            document.getElementById('scatterMean').addEventListener('change', updateScatterPlot);
            document.getElementById('scatterMedian').addEventListener('change', updateScatterPlot);
            document.getElementById('scatterStd').addEventListener('change', updateScatterPlot);
            document.getElementById('scatterGrid').addEventListener('change', updateScatterPlot);
            document.getElementById('scatterLogX').addEventListener('change', updateScatterPlot);
            document.getElementById('scatterLogY').addEventListener('change', updateScatterPlot);
        }
    </script>
</body>
</html> 